name: Make CI

on: [push]

defaults:
  run:
    working-directory: src

jobs:
  # Compile:

  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       cc: [gcc, clang]

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Basic
  #     run: make CC=${{ matrix.cc }} basic

  #   - name: Dev
  #     run: make CC=${{ matrix.cc }} dev

  #   - name: Releases
  #     run: make CC=${{ matrix.cc }} release

  #   - name: PGO
  #     if: matrix.cc == 'gcc'
  #     run: make CC=${{ matrix.cc }} pgo

  # Bench:

  #   needs: Compile

  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       cc: [gcc, clang]

  #   steps:
  #   - uses: actions/checkout@v3

  #   - name: Compile
  #     run: make CC=${{ matrix.cc }} basic

  #   - name: Bench
  #     run: |
  #       expected=$(git show --summary | grep -Po '(?<=Bench: )[0-9]+?(?=$)')
  #       actual=$(./weiss bench | tail -n 1 | grep -Po '(?<=[\s]{5})[0-9]+?(?= nodes)')
  #       if [[ $actual != $expected ]]; then echo "Expected $expected was $actual" && exit 1; fi

  Perft:

    # needs: Compile

    runs-on: ubuntu-latest
    strategy:
      matrix:
        perftsuite: [perftsuite.epd, frc_perftsuite.epd]

    steps:
    - uses: actions/checkout@v1

    - name: Compile
      run: make dev

    - name: Perft
      run: |
        wget -O- https://raw.githubusercontent.com/TerjeKir/EngineTests/master/testfiles/${{ matrix.perftsuite }} | while read p; do
          echo $p
          if [[ ${{ matrix.perftsuite }} == perftsuite.epd ]]; then depth=5; else depth=4; fi
          expected=$(echo $p | grep -Po '(?<=;D'$depth' )[0-9]+?(?= )')
          actual=$(printf "perft $depth $p" | ./weiss | grep -Po '(?<=Nodes: )[0-9]+?(?=$)')
          if [[ $actual != $expected ]]; then echo "Expected $expected was $actual" && exit 1; fi
        done

    # - name: FRC Perft
    #   run: |
    #     wget -q -O- https://raw.githubusercontent.com/TerjeKir/EngineTests/master/testfiles/frc_perftsuite.epd | while read p; do
    #       echo $p
    #       expected=$(echo $p | grep -Po '(?<=;D5 )[0-9]+?(?= )')
    #       actual=$(printf "perft 5 $p" | ./weiss | grep -Po '(?<=Nodes: )[0-9]+?(?=$)')
    #       if [[ $actual != $expected ]]; then echo "Expected $expected was $actual" && exit 1; fi
    #     done
